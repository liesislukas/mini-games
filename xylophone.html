<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xylophone Fun</title>

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Tone.js for audio synthesis -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <!-- ml5.js for Pitch Detection -->
    <script src="https://unpkg.com/ml5@0.9.0/dist/ml5.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .xylophone-key {
            transition: transform 0.1s ease, box-shadow 0.1s ease, background-color 0.1s ease;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 1rem;
        }

        .xylophone-key.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .xylophone-key.active {
            transform: scale(0.95) translateY(4px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .key-label {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
            pointer-events: none;
        }

        .note-guide-item.current {
            transform: scale(1.2);
            color: #3b82f6;
        }

        .dark .note-guide-item.current {
            color: #60a5fa;
        }

        .note-guide-item {
            transition: transform 0.2s ease-in-out, color 0.2s ease-in-out;
        }

        .success-message {
            animation: fadeInOut 3s forwards;
        }

        @keyframes fadeInOut {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            20% {
                opacity: 1;
                transform: translateY(0);
            }
            80% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-20px);
            }
        }

        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='2' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19.5 8.25l-7.5 7.5-7.5-7.5' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        .dark select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='2' stroke='white'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19.5 8.25l-7.5 7.5-7.5-7.5' /%3E%3C/svg%3E");
        }

        .modal-overlay {
            transition: opacity 0.2s ease-in-out;
        }
    </style>
    <script>
        function requestMicAccess() {
            navigator.mediaDevices.getUserMedia({audio: true})
                .then(function (stream) {
                    console.log('Microphone access granted.');
                    // You can now use the audio stream
                })
                .catch(function (err) {
                    console.error('Microphone access denied:', err);
                });
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 flex flex-col items-center justify-center min-h-screen p-4">

<div id="app" class="w-full max-w-4xl mx-auto text-center">
    <h1 class="text-4xl md:text-5xl font-bold mb-2">Xylophone Fun</h1>
    <div class="mb-4">
        <select id="song-selector"
                class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 text-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-full max-w-xs mx-auto"></select>
    </div>
    <p id="subtitle" class="text-lg text-gray-600 dark:text-gray-400 mb-6"></p>

    <div id="note-guide"
         class="flex flex-wrap justify-center items-center gap-x-2 md:gap-x-4 h-auto min-h-[4rem] mb-6 bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md"></div>

    <div id="xylophone"
         class="flex flex-col md:flex-row justify-center items-center md:items-end md:space-x-2 space-y-2 md:space-y-0 p-4"></div>

    <div class="mt-8 flex justify-center items-center space-x-4">
        <button id="autoplay-btn"
                class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg shadow-md transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75">
            <i class="fas fa-play mr-2"></i> Play Song
        </button>
        <button id="reset-btn"
                class="px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg shadow-md transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">
            <i class="fas fa-undo mr-2"></i> Reset Song
        </button>
    </div>

    <!-- Microphone Controls -->
    <div id="mic-controls" class="mt-6 p-4 bg-white dark:bg-gray-800 rounded-xl shadow-md">
        <button
                onclick="requestMicAccess()"
                id="mic-btn"
                class="px-6 py-3 bg-teal-500 hover:bg-teal-600 text-white font-semibold rounded-lg shadow-md transition-transform transform hover:scale-105">
            <i class="fas fa-microphone-alt mr-2"></i> Listen with Mic
        </button>
        <div id="mic-status" class="mt-2 text-gray-600 dark:text-gray-400 h-6">Mic is off</div>
    </div>

    <div id="progress-tracker" class="mt-8 bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md">
        <h2 class="text-xl font-bold mb-2">Your Progress</h2>
        <div class="flex justify-center space-x-8 text-lg">
            <div><span class="font-semibold">Songs Completed:</span> <span id="songs-completed">0</span></div>
            <div><span class="font-semibold">Notes Hit:</span> <span id="notes-hit">0</span></div>
        </div>
        <button id="reset-progress-btn"
                class="mt-4 px-4 py-2 text-sm bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg shadow-md">
            <i class="fas fa-trash-alt mr-2"></i> Reset Progress
        </button>
    </div>

    <div id="success-message"
         class="fixed top-1/4 left-1/2 -translate-x-1/2 text-2xl font-bold bg-green-500 text-white px-8 py-4 rounded-xl shadow-lg opacity-0"
         style="pointer-events: none;">Great Job! ðŸŽ‰
    </div>
</div>

<!-- Custom Confirmation Modal -->
<div id="confirm-modal"
     class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 opacity-0 pointer-events-none">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
        <p id="modal-text" class="text-lg mb-4">Are you sure?</p>
        <div class="flex justify-center space-x-4">
            <button id="modal-cancel-btn" class="px-6 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg">Cancel</button>
            <button id="modal-confirm-btn" class="px-6 py-2 bg-red-500 text-white rounded-lg">Confirm</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const appElements = {
            xylophone: document.getElementById('xylophone'),
            noteGuide: document.getElementById('note-guide'),
            autoplayBtn: document.getElementById('autoplay-btn'),
            resetBtn: document.getElementById('reset-btn'),
            micBtn: document.getElementById('mic-btn'),
            micStatus: document.getElementById('mic-status'),
            songSelector: document.getElementById('song-selector'),
            subtitle: document.getElementById('subtitle'),
            songsCompleted: document.getElementById('songs-completed'),
            notesHit: document.getElementById('notes-hit'),
            resetProgressBtn: document.getElementById('reset-progress-btn'),
            successMessage: document.getElementById('success-message'),
            modal: document.getElementById('confirm-modal'),
            modalText: document.getElementById('modal-text'),
            modalConfirmBtn: document.getElementById('modal-confirm-btn'),
            modalCancelBtn: document.getElementById('modal-cancel-btn'),
        };

        // --- Audio & Pitch Detection ---
        const synth = new Tone.Synth({
            oscillator: {type: 'sine'},
            envelope: {attack: 0.01, decay: 0.1, sustain: 0.3, release: 0.5}
        }).toDestination();
        let pitch;
        let audioContext;
        let mic;

        // --- Game Data ---
        const songs = [
            {
                name: "Happy Birthday",
                notes: ['C4', 'C4', 'D4', 'C4', 'F4', 'E4', 'C4', 'C4', 'D4', 'C4', 'G4', 'F4', 'C4', 'C4', 'C5', 'A4', 'F4', 'E4', 'D4', 'Bb4', 'Bb4', 'A4', 'F4', 'G4', 'F4']
            },
            {
                name: "Twinkle Twinkle",
                notes: ['C4', 'C4', 'G4', 'G4', 'A4', 'A4', 'G4', 'F4', 'F4', 'E4', 'E4', 'D4', 'D4', 'C4', 'G4', 'G4', 'F4', 'F4', 'E4', 'E4', 'D4', 'G4', 'G4', 'F4', 'F4', 'E4', 'E4', 'D4', 'C4', 'C4', 'G4', 'G4', 'A4', 'A4', 'G4', 'F4', 'F4', 'E4', 'E4', 'D4', 'D4', 'C4']
            }
        ];
        const noteFrequencies = {
            'C4': 261.63,
            'D4': 293.66,
            'E4': 329.63,
            'F4': 349.23,
            'G4': 392.00,
            'A4': 440.00,
            'Bb4': 466.16,
            'C5': 523.25
        };
        const xylophoneKeysData = [
            {note: 'C4', color: 'bg-red-500', height: 'h-48'}, {
                note: 'D4',
                color: 'bg-orange-500',
                height: 'h-44'
            }, {note: 'E4', color: 'bg-yellow-400', height: 'h-40'}, {
                note: 'F4',
                color: 'bg-green-500',
                height: 'h-36'
            }, {note: 'G4', color: 'bg-teal-500', height: 'h-32'}, {
                note: 'A4',
                color: 'bg-blue-500',
                height: 'h-28'
            }, {note: 'Bb4', color: 'bg-indigo-500', height: 'h-24'}, {note: 'C5', color: 'bg-pink-500', height: 'h-20'}
        ];

        // --- Game State ---
        let state = {
            currentSong: songs[0],
            currentNoteIndex: 0,
            isAutoplaying: false,
            isListening: false,
            lastDetectedNote: null,
            progress: {songsCompleted: 0, notesHit: 0},
        };
        const delay = ms => new Promise(res => setTimeout(res, ms));

        // --- Functions ---

        function loadProgress() {
            const saved = localStorage.getItem('xylophoneProgress');
            if (saved) state.progress = JSON.parse(saved);
            updateProgressDisplay();
        }

        function saveProgress() {
            localStorage.setItem('xylophoneProgress', JSON.stringify(state.progress));
        }

        function updateProgressDisplay() {
            appElements.songsCompleted.textContent = state.progress.songsCompleted;
            appElements.notesHit.textContent = state.progress.notesHit;
        }

        function playNote(note, duration = '8n') {
            if (Tone.context.state !== 'running') Tone.context.resume();
            synth.triggerAttackRelease(note, duration);
            const keyElement = document.querySelector(`.xylophone-key[data-note="${note}"]`);
            if (keyElement) {
                keyElement.classList.add('active');
                setTimeout(() => keyElement.classList.remove('active'), 200);
            }
        }

        function handleNoteInput(note) {
            if (state.isAutoplaying) return;

            if (!state.isListening) playNote(note);

            if (note === state.currentSong.notes[state.currentNoteIndex]) {
                state.progress.notesHit++;
                state.currentNoteIndex++;
                saveProgress();
                updateProgressDisplay();
                highlightCurrentNote();

                if (state.currentNoteIndex >= state.currentSong.notes.length) {
                    state.progress.songsCompleted++;
                    saveProgress();
                    updateProgressDisplay();
                    appElements.successMessage.classList.add('success-message');
                    setTimeout(() => {
                        appElements.successMessage.classList.remove('success-message');
                        resetSong();
                    }, 3000);
                }
            }
        }

        function setupXylophone() {
            appElements.xylophone.innerHTML = '';
            xylophoneKeysData.forEach(keyData => {
                const keyElement = document.createElement('div');
                keyElement.dataset.note = keyData.note;
                keyElement.className = `xylophone-key w-16 md:w-12 ${keyData.height} ${keyData.color} rounded-lg shadow-lg border-b-8 border-black/20`;

                const label = document.createElement('span');
                label.className = 'key-label';
                label.textContent = keyData.note.slice(0, -1).replace('b', 'â™­');
                keyElement.appendChild(label);

                keyElement.addEventListener('click', () => {
                    if (!state.isListening) handleNoteInput(keyData.note);
                });
                appElements.xylophone.appendChild(keyElement);
            });
        }

        function renderNoteGuide() {
            appElements.noteGuide.innerHTML = '';
            state.currentSong.notes.forEach((note, index) => {
                const noteElement = document.createElement('div');
                noteElement.textContent = note.slice(0, -1).replace('b', 'â™­') + (note.includes('5') ? "'" : "");
                noteElement.id = `note-guide-${index}`;
                noteElement.className = 'note-guide-item text-xl md:text-2xl font-semibold text-gray-400 dark:text-gray-500';
                appElements.noteGuide.appendChild(noteElement);
            });
            highlightCurrentNote();
        }

        function highlightCurrentNote() {
            document.querySelectorAll('.note-guide-item.current').forEach(el => el.classList.remove('current'));
            if (state.currentNoteIndex < state.currentSong.notes.length) {
                document.getElementById(`note-guide-${state.currentNoteIndex}`)?.classList.add('current');
            }
        }

        async function setupMicrophone() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                await audioContext.resume(); // Resume context on user gesture
                mic = new p5.AudioIn();
                await new Promise((resolve, reject) => mic.start(resolve, reject));
                const modelURL = 'https://cdn.jsdelivr.net/gh/ml5js/ml5-data-and-models/models/pitch-detection/crepe/';
                pitch = ml5.pitchDetection(modelURL, audioContext, mic.stream, modelLoaded);
            } catch (err) {
                appElements.micStatus.textContent = "Mic access failed.";
                console.error("Error setting up microphone:", err);
            }
        }

        function modelLoaded() {
            appElements.micStatus.textContent = 'Listening...';
            getPitch();
        }

        function getPitch() {
            if (!state.isListening) return;
            pitch.getPitch((err, frequency) => {
                if (err) console.error(err);
                if (frequency) {
                    const detectedNote = frequencyToNote(frequency);
                    if (detectedNote) {
                        appElements.micStatus.textContent = `Heard: ${detectedNote}`;
                        if (detectedNote !== state.lastDetectedNote) {
                            handleNoteInput(detectedNote);
                            state.lastDetectedNote = detectedNote;
                            setTimeout(() => {
                                state.lastDetectedNote = null;
                            }, 500);
                        }
                    }
                }
                requestAnimationFrame(getPitch);
            });
        }

        function frequencyToNote(frequency) {
            let closestNote = null;
            let smallestDifference = Infinity;
            for (const note in noteFrequencies) {
                const difference = Math.abs(frequency - noteFrequencies[note]);
                if (difference < smallestDifference) {
                    smallestDifference = difference;
                    closestNote = note;
                }
            }
            return smallestDifference < 30 ? closestNote : null;
        }

        function toggleListening() {
            state.isListening = !state.isListening;
            if (state.isListening) {
                appElements.micBtn.innerHTML = '<i class="fas fa-microphone-alt-slash mr-2"></i> Stop Listening';
                appElements.micBtn.classList.replace('bg-teal-500', 'bg-red-500');
                appElements.micBtn.classList.replace('hover:bg-teal-600', 'hover:bg-red-600');
                document.querySelectorAll('.xylophone-key').forEach(k => k.classList.add('disabled'));
                if (!pitch) {
                    appElements.micStatus.textContent = 'Starting mic...';
                    setupMicrophone();
                } else {
                    getPitch();
                }
            } else {
                appElements.micBtn.innerHTML = '<i class="fas fa-microphone-alt mr-2"></i> Listen with Mic';
                appElements.micBtn.classList.replace('bg-red-500', 'bg-teal-500');
                appElements.micBtn.classList.replace('hover:bg-red-600', 'hover:bg-teal-600');
                appElements.micStatus.textContent = 'Mic is off';
                document.querySelectorAll('.xylophone-key').forEach(k => k.classList.remove('disabled'));
            }
        }

        async function autoplaySong() {
            if (state.isAutoplaying || state.isListening) return;
            state.isAutoplaying = true;
            appElements.autoplayBtn.disabled = true;
            appElements.resetBtn.disabled = true;
            appElements.micBtn.disabled = true;

            await Tone.start();

            for (let i = 0; i < state.currentSong.notes.length; i++) {
                const note = state.currentSong.notes[i];
                document.querySelectorAll('.note-guide-item.current').forEach(el => el.classList.remove('current'));
                document.getElementById(`note-guide-${i}`)?.classList.add('current');
                playNote(note, '4n');
                await delay(400);
            }

            await delay(500);
            state.isAutoplaying = false;
            appElements.autoplayBtn.disabled = false;
            appElements.resetBtn.disabled = false;
            appElements.micBtn.disabled = false;
            resetSong();
        }

        function resetSong() {
            state.currentNoteIndex = 0;
            highlightCurrentNote();
        }

        function loadSong(songIndex) {
            state.currentSong = songs[songIndex];
            appElements.subtitle.textContent = `Learn to play "${state.currentSong.name}"`;
            renderNoteGuide();
            resetSong();
        }

        function setupSongSelector() {
            songs.forEach((song, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = song.name;
                appElements.songSelector.appendChild(option);
            });
        }

        function showConfirmationModal(text, onConfirm) {
            appElements.modalText.textContent = text;
            appElements.modal.classList.remove('opacity-0', 'pointer-events-none');

            const confirmHandler = () => {
                onConfirm();
                hideModal();
            };
            const hideModal = () => {
                appElements.modal.classList.add('opacity-0', 'pointer-events-none');
                appElements.modalConfirmBtn.removeEventListener('click', confirmHandler);
                appElements.modalCancelBtn.removeEventListener('click', hideModal);
            };

            appElements.modalConfirmBtn.addEventListener('click', confirmHandler, {once: true});
            appElements.modalCancelBtn.addEventListener('click', hideModal, {once: true});
        }

        // --- Initialization ---
        setupXylophone();
        setupSongSelector();
        loadProgress();
        loadSong(0);

        // --- Event Listeners ---
        appElements.autoplayBtn.addEventListener('click', autoplaySong);
        appElements.resetBtn.addEventListener('click', resetSong);
        appElements.songSelector.addEventListener('change', (e) => loadSong(e.target.value));
        appElements.micBtn.addEventListener('click', toggleListening);
        appElements.resetProgressBtn.addEventListener('click', () => {
            showConfirmationModal("Reset all progress? This cannot be undone.", () => {
                state.progress = {songsCompleted: 0, notesHit: 0};
                saveProgress();
                updateProgressDisplay();
            });
        });
    });
</script>
</body>
</html>
